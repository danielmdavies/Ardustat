<!doctype html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name ="viewport" content="width=device-width">
    <title>Cyclic Voltammetry</title>
    <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.min.css"> 
    <link rel="stylesheet" href="/stylesheets/style.css">
</head>
<body>
  <div class="container">
      <div class="row marketing">
        <div>
          <div class="navbar navbar-default" role="navigation">
            <div class="container-fluid">
              <div class="navbar-header">
                <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".navbar-collapse">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Ardustat</a>
              </div>
              <nav class="collapse navbar-collapse" role="navigation">
                <ul class="nav navbar-nav navbar-right">
                    <li id='navbar-home'><a href="/">Home</a></li>
                    <li id='navbar-channel1'><a href="/Channel1">Channel 1</a></li>
                    <li id='navbar-channel2'><a href="/Channel2">Channel 2</a></li>
                    <li id='navbar-analysis'><a href="/Analysis">Analysis</a></li>
                </ul>
              </nav>
            </div>
          </div>
          <script type="text/javascript" >
            document.getElementById('navbar-channel1').setAttribute('class', 'active')
          </script>
        </div>

          <div class="col-lg-12">
            <h1 class="header"> Hey Dan </h1>
          </div>
      </div>
      <div id="tabs">
        <ul class = "nav nav-tabs">
            <li class="active"><a href="#tabs-1">Setup</a></li>
            <li><a href="#tabs-2">Plotting</a></li>
        </ul>
        
        <section id="tabs-1" class="active">
        <div>

            <div class="row marketing">
                <div class="col-lg-12">
                    <h1>Cyclic Voltammetry Setup</h1>
                </div>
            </div>
          <form id='cv_setup_input' action='/senddata' method='post'>
          <input type='hidden' name='electro_function' value='cyclic_voltammetry'><br>
          Http Port: <input type='text' name='http_port' value='8001' class="form-inline"><br>
          Serial Port: <input type='text' name='serial_port' value='/dev/ttyACM0' class="form-inline"><br>
          Ardustat Id: <input type='text' name='ardustat_id' value='25' class="form-inline"><br>
          Folder Name: <input type='text' name='folder_name' value='folder' class="form-inline"><br>
          Experiment Name: <input type='text' name='file_name' value='file_name_again' class="form-inline"><br>
          Rest Time: <input type='text' name='rest_time' value='10' class="form-inline"><br>
          Number of Cycles <input type='text' name='number_of_cycles' value='2' class="form-inline"><br>
          Minimum Potential <input type='text' name='min_potential' value='-.5' class="form-inline"><br>
          Maximum Potential <input type='text' name='max_potential' value='1' class="form-inline"><br>
          Rate: <input type='text' name='rate' value='1' class="form-inline"> mV/s<br>
          DAC2 Val: <input type='text' name='DAC2_value' value='2.5'><br>
          Max and Min Potentials relative to OCV? <input type='checkbox' name='relative_to_ocv' value='True' class="form-inline"> True <br>
          Start test
           at OCV? <input type = 'checkbox' name='start_at_ocv' value='True' class="form-inline"> If other - Please Specify 
          <input type='text' name='other_start_volt' class="form-inline"><br>
          Start Direction <select name='cv_dir' class="form-inline"> 
            <option value='charging'> Charge </option>
            <option value='discharging'> Discharge</option>
            </select>
          

          <br>
          <br>
      <div id="not_underway_display" style="display:inline-block">
        <textarea id="tbTableValuesArray" name="tblValuesArray" rows="10" class='textarea' style="display:none" ></textarea>
        <p id="cyc_confirm" style="display:none"> Waiting for Properties to be Confirmed </p>
        <button id="start_experiment" class="btn btn-primary">Start The Experiment</button>
      </div>
      
      <div id="underway_display" style="display:none">
      </div>
        
        <div id="in_test_buttons" >
          <button type = "button" onclick="goPlotting()" class="btn btn-success" id="goPlotting_button" style="display:none">View Live Plot</button>
          <button type = "pause_button" onclick="goPause()" class="btn btn-warning" id="pause_button" style="display:none">Pause Test</button>
          <button type = "kill_button" onclick="goKill()"  class="btn btn-danger" id="kill_button" style="display:none">Stop Test</button>
          <button type = "resume_button" onclick="goResume()" class="btn btn-primary" id="resume_button" style="display:none">Resume Test</button>
        </div>
        
   
       
        
        
          

  </section>
  
  <section id="tabs-2" class="hide">
    
    <div class="row marketing">
    
      <h1>Live Plotting</h1>
      
      <div id="underway_display_plot" style="display:inline-block"> 
        <p>Click links to display different live plots</p>
      

        <table><tr>
            <td><button type="button" class="btn btn-default" id="chooseP1" onclick="chooseP(1,ploop)">Current vs. Voltage</button></td>
            <td><button type="button" class="btn btn-default" id="chooseP2" onclick="chooseP(2,ploop)">Current vs. Time</button></td>
            <td><button type="button" class="btn btn-default" id="chooseP3" onclick="chooseP(3,ploop)">Voltage vs. Time</button></td> </tr>
        </table><br>

        
        <img id="fooplotter" src="http://coolstuffiknow.files.wordpress.com/2012/04/cool_003.jpg" width and height stuff">
        
        <p><tt id="results"></tt></p>
        
        <button type = "pause_button_plot" onclick="goPause()" class="btn btn-warning" id="pause_button_plot" style="display:inline-block">Pause Test</button>
        <button type = "kill_button_plot" onclick="goKill()" class="btn btn-danger" id="kill_button_plot" style="display:inline-block">Stop Test</button>
        <button type = "resume_button_plot" onclick="goResume()" class="btn btn-primary" id="resume_button_plot" style="display:none">Resume Test</button>

      </div>
      
      <div id="not_underway_display_plot" style="display:none">
        There is no experiment running right now
      </div>
      
      <div id="returnButton" style="display:none">
        <a href="/Channel1"> Return </a>
      </div>

  </section>
  </div>
</div>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" ></script>
	<script src="/javascripts/flot/jquery.flot.js"></script>
	<script src="/javascripts/flot/jquery.flot.time.js"></script>
	<script src="/javascripts/jquery-json/src/jquery.json.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
  <script src="/scripts/socket_1.js"></script>
  <script>

//debug
  
//starting the stuff ----------------------------------------------------
  $('#start_experiment').click(function() {
    goStartTest()
  });
  
  $('#kill_button').click(function() {
    console.log("kill button pushed");
    location.href='/Channel1'
  });
  

  function goStartTest()
  {
    sendValues();
    disableInputs();
    showButtons();
    testUnderway();
  }

  $.fn.serializeObject = function()
  {
      var o = {};
      var a = this.serializeArray();
      $.each(a, function() {
          if (o[this.name] !== undefined) {
              if (!o[this.name].push) {
                  o[this.name] = [o[this.name]];
              }
              o[this.name].push(this.value || '');
          } else {
              o[this.name] = this.value || '';
          }
      });
      o['type_of_experiment'] = 'cyclic voltammetry';
      return o;
  };


var DataToSend;
//Sends values to start things make plotting, kill, and pause button visible
//
  function sendValues() 
  {
    var form = $('#cv_setup_input');
    DataToSend = form.serializeObject();
    console.log(DataToSend);
    $.ajax({
      type:'POST',
      url:'/senddata',
      dataType: 'json',
      async: true,
      data: DataToSend,
      success: function(){
        console.log('successful sending of things :)');
      }
    });
  }
  
  $('#returnButton').click(function() {
    console.log('returnButton clicked')
    goBackToStart();
  });

  function goBackToStart()
  {
  console.log('goBackToStart called');
  showButtons()
  $("#resume_button").style.display="none";
  enableInputs()
  }

  function testUnderway()
  {
    console.log('testUnderway called');
    document.getElementById('not_underway_display').style.display = 'none';
    document.getElementById('underway_display').style.display = 'inline-block';
    document.getElementById('not_underway_display_plot').style.display = 'none';
    document.getElementById('underway_display_plot').style.display = 'inline-block';
  }
  
  function testOver()
  {
    console.log('testOver called');
    document.getElementById('not_underway_display').style.display = 'inline-block';
    document.getElementById('underway_display').style.display = 'none';
    document.getElementById('not_underway_display_plot').style.display = 'inline-block';
    document.getElementById('underway_display_plot').style.display = 'none';
  }
  
  function enableInputs()
  {
    console.log('enable inputs called');
    var inputs = document.getElementsByTagName("INPUT");
    for (var i = 0; i < inputs.length; i++) 
    {
      inputs[i].disabled = false;
      //console.log(inputs[i]);
    }
  }
  
  function disableInputs()
  {
    console.log('diable inputs called');
    var inputs = document.getElementsByTagName("INPUT");
    for (var i = 0; i < inputs.length; i++) 
    {
      inputs[i].disabled = true;
      //console.log(inputs[i]);
    }
  }
// additional control 
  function showButtons()
  {
    document.getElementById("goPlotting_button").style.display="inline-block"; //definitely cleaner way to write this
    document.getElementById("kill_button").style.display="inline-block";
    document.getElementById("pause_button").style.display="inline-block";
  }
  
  function hideButtons()
  {
    document.getElementById("goPlotting_button").style.display="none"; //definitely cleaner way to write this
    document.getElementById("kill_button").style.display="none";
    document.getElementById("pause_button").style.display="none";
    document.getElementById("resume_button").style.display="none";
  }
  function showReturnButton()
  {
    document.getElementById("returnButton").style.display="inline-block";
  }
  
  
  
  //pause the test, show resume button
  //this is hacky and i should write in a better way - like 
  function goPause() 
  {
    document.getElementById("goPlotting_button").style.display="none"; //definitely cleaner way to write this
    document.getElementById("resume_button").style.display="inline-block";
    document.getElementById("kill_button").style.display="inline-block";
    document.getElementById("pause_button").style.display="none";
    
    
    document.getElementById("kill_button_plot").style.display="inline-block";
    document.getElementById("pause_button_plot").style.display="none";
    document.getElementById("resume_button_plot").style.display="inline-block";
    console.log('goPause called')
    $.ajax({
      type:'GET',
      url:'/pauser', //was killing or something - will have to check to make sure this works. 
      dataType: 'json',
      async: true,
      success: function(){
        console.log('ajax says killer called');
      }
    });
  }
  
  //resume the test
  function goResume()
  {
    document.getElementById("pause_button").style.display="inline-block";
    document.getElementById("resume_button").style.display="none";
    document.getElementById("goPlotting_button").style.display="inline-block";
    
    document.getElementById("pause_button_plot").style.display="inline-block";
    document.getElementById("resume_button_plot").style.display="none";
    console.log('goResume called')
    $.ajax({
      type:'GET',
      url:'/reviver',
      dataType: 'json',
      async: true,
      success: function(){
        console.log('ajax says killer called');
      }
    });
  }
  
  //kill the test, take back to setup (page with CV, Cycle etc.)
  function goKill()
  {
  enableInputs()
  hideButtons()
  showReturnButton()
  testOver() // could probably consolidate these things - but oh well.
    console.log('goKill called')
    $.ajax({
      type:'GET',
      url:'/killing',
      dataType: 'json',
      async: true,
      success: function(){
        console.log('ajax says killer called');
      }
    });
  }
//------------------------------------------------------------------------------------
  
//debugging
	$("#cv_submit_button").click(function(){
	  console.log('something got clicked');
	  var jim = document.forms['cv_setup_input'].elements
	  var array = document.forms['cv_setup_input'].elements.value
	  console.log(array);
				
	});  

//----------------------------------------------
//plotting stuff
  function goPlotting(){
    event.preventDefault();
    console.log("goPlotting got called");
    
    var active_tab_selector = $('.nav-tabs > li.active > a').attr('href');
    
    var actived_nav = $('.nav-tabs > li.active');
    actived_nav.removeClass('active');
    
    //manually switch to plotting tab
    //addClass('active');
    $("a[href$='tabs-2']").parents('li').addClass('active');
    
    //hide current tab
    $(active_tab_selector).removeClass('active');
    $(active_tab_selector).addClass('hide');
    console.log("active_tab");
    console.log($(active_tab_selector));
    
    //display plotting tab
    var target_tab_selector = $('#tabs-2');
    console.log("target tab selector");
    console.log($(target_tab_selector));
    $(target_tab_selector).removeClass('hide');
    $(target_tab_selector).addClass('active');
    ploop();
    setInterval(function() {
      console.log('ploop was called again');
      ploop();
    }, 2000);
  }
  
  function changePlot(xaxis,yaxis,callback)
  {
    callback();
  }
  
  function chooseP(ptype,callback) 
  { plot = ptype; 
    selected = true;
    if(plot == 1) { CV_Xaxis = 'v'; CV_Yaxis = 'c' }
    if(plot == 2) { CV_Xaxis = 't'; CV_Yaxis = 'c'  }
    if(plot == 3) { CV_Xaxis = 't'; CV_Yaxis = 'v'  }
    callback()
  }
  
  // global varibles for plotting - might run into problems - but yolo swag
  var CV_Xaxis = ''
  var CV_Yaxis = ''
  function ploop()
  {
      //TODO: add in a cycmin and cycmax thing
      //document.write("ploop was called");
      //var mintemp = document.getElementById("cycmin").value;
      //var maxtemp = document.getElementById("cycmax").value;
      if (CV_Xaxis == '') { CV_Xaxis = 'v'}
      if (CV_Yaxis == '') { CV_Yaxis = 'c'}
      var mintemp = 0;
      var maxtemp = -1;
      var ardu_folder = DataToSend['folder_name'];
      var ardu_file = DataToSend['file_name'];
      if(mintemp != "") { cycle_min = mintemp; }
      else { cycle_min = 0 }
      if(maxtemp != "") { cycle_max = maxtemp; }
      else { cycle_max = -1 }
      //add functionality so that can look at different plots
      var foo = "test";
      $.ajax({
      url: "http://localhost:4004/filetest_showme/" //TODO: make this more general, or in readme make sure that user sets pithy on 4001, 4003, 4004 
      + ardu_folder+"/"
      + ardu_file+"/"
      + cycle_min+"/"
      + cycle_max+"/"
      + CV_Xaxis+"/"
      + CV_Yaxis+"/",
      success: function(result){
          image = result
          //debug
          console.log('result from ploop');
          console.log(result);
          imageUrl = "http://localhost:4001/"+image
          //document.write(imageUrl);
          changeImage("fooplotter",imageUrl)
      },
      async:   false,
      })
  }
  
  function changeImage(id,source)
  {
  document.getElementById(id).src=source;
  }
  
//----------------------------------------------------------------  
//tab stuff
$(document).ready(function() {
    $('.nav-tabs > li > a').click(function(event){
    event.preventDefault();//stop browser to take action for clicked anchor'
    console.log("you got clicked");

    //get displaying tab content jQuery selector
    var active_tab_selector = $('.nav-tabs > li.active > a').attr('href');					

    //find actived navigation and remove 'active' css
    var actived_nav = $('.nav-tabs > li.active');
    actived_nav.removeClass('active');

    //add 'active' css into clicked navigation
    $(this).parents('li').addClass('active');
    console.log("parents");
    console.log($(this).parents('li'));

    //hide displaying tab content
    $(active_tab_selector).removeClass('active');
    $(active_tab_selector).addClass('hide');
    //console.log("active tab selector");
    //console.log($(active_tab_selector));

    //show target tab content
    var target_tab_selector = $(this).attr('href');
    //var target_tab_selector = $('.nav-tabs > #tabs-2').attr('href');
    //console.log("target tab selector");
    //console.log($(target_tab_selector));
    $(target_tab_selector).removeClass('hide');
    $(target_tab_selector).addClass('active');
     });
});       
        
        
    /*
    // do on click thing - then loop through to find each element - then post it.
    
        
        $.ajax({
          type: 'POST',
        	dataType: "json",
        	async: true,
        	url: '/senddata',
        	data: {cv_setup:$("#cv_setup_input").val()},
        	success: function("here is the stuff "+stuff){
            console.log(stuff);
          }
      });
    });
    */
  </script>
</body>
