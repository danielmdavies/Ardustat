<!doctype html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name ="viewport" content="width=device-width">
    <title>Setup Cycler</title>
    <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.min.css"> 
    <link rel="stylesheet" href="/stylesheets/style.css">
</head>
<body>
  <div class="container">
      <div class="row marketing">
        <div>
          <div class="navbar navbar-default" role="navigation">
            <div class="container-fluid">
              <div class="navbar-header">
                <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".navbar-collapse">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Ardustat</a>
              </div>
              <nav class="collapse navbar-collapse" role="navigation">
                <ul class="nav navbar-nav navbar-right">
                    <li id='navbar-home'><a href="/">Home</a></li>
                    <li id='navbar-channel1'><a href="/Channel1">Channel 1</a></li>
                    <li id='navbar-channel2'><a href="/Channel2">Channel 2</a></li>
                    <li id='navbar-analysis'><a href="/Analysis">Analysis</a></li>
                </ul>
              </nav>
            </div>
          </div>
          <script type="text/javascript" >
            document.getElementById('navbar-channel1').setAttribute('class', 'active')
          </script>
        </div>

          <div class="col-lg-12">
            <h1 class="header"> Hey Dan </h1>
          </div>
      </div>
   
    <div id="tabs">
      <ul class = "nav nav-tabs">
          <li class="active"><a href="#tabs-1">Setup</a></li>
          <!-- see if this is the same --> 
          <li><a href="#tabs-2">Plotting</a></li>
      </ul>
      
      <section id="tabs-1" class="active">
      <div>

          <div class="row marketing">
              <div class="col-lg-12">
                  <h1>Cycler Setup</h1>
              </div>
          </div>
      <div id="basic_setup">
        <table id="basic_setup_table" class='table'>
          <input type='hidden' name='electro_function' value='cyclic_voltammetry'>
          <tr> <td> Http Port: </td><td><input type='text' id='http_port' value='8001'></td></tr> 
          <tr> <td>Serial Port: </td><td><input type='text' id='serial_port' value='/dev/ttyACM0'></td></tr> 
          <tr> <td>Ardustat Id: </td><td><input type='text' id='ardustat_id' value='25'></td></tr>
          <tr> <td>Folder Name: </td><td><input type='text' id='folder_name' value='folder'></td></tr>
          <tr> <td>Experiment Name: </td><td><input type='text' id='file_name' value='file_name_cycle'></td></tr>
          <tr> <td>Number of Cycles </td><td><input type='text' id='number_of_cycles' value='2'></td></tr>
        </table>
      </div>

        <table id="cycler_table" class='table'>
          <tr>
            <th>Cycle Step</th> <th>Mode</th> <th> Value </th> <th>Time Cutoff</th> <th>Voltage Cutoff</th> <th>Current Cuttoff</th>
          </tr>
          <tr>
            <td>1</td>  <td><select name='cyc_mode1'> <option value='galvanostatic'>Galvanostatic</option> <option value='Potentiostatic'>Potentiostatic</option> <option name='rest'>Rest</option></td> <td><input type='text' name='value' value='1' >Either V or mA</td> <td><input type='text' name='time_cutoff1' value='10'></td> <td><input type='text' name='voltage_cutoff1' value='0'></td> <td><input type='text' name='current_cutoff1' value='0'></td>
          </tr>
          <tr>
            <td>2</td>  <td><select name='cyc_mode2'> <option value='galvanostatic'>Galvanostatic</option> <option value='Potentiostatic'>Potentiostatic</option> <option name='rest'>Rest</option></td> <td><input type='text' name='value' value='-1'>Either V or mA</td> <td><input type='text' name='time_cutoff2' value='15'></td> <td><input type='text' name='voltage_cutoff2' value='0'></td> <td><input type='text' name='current_cutoff2' value='0'></td>
          </tr>
          <tr>
            <td>3</td>  <td><select name='cyc_mode3'> <option value='galvanostatic'>Galvanostatic</option> <option value='Potentiostatic'>Potentiostatic</option> <option name='rest'>Rest</option></td> <td><input type='text' name='value' value='2'>Either V or mA</td> <td><input type='text' name='time_cutoff3' value='5'></td> <td><input type='text' name='voltage_cutoff3' value='0'></td> <td><input type='text' name='current_cutoff3' value='0'></td>
          </tr>
          <tr>
            <td>4</td>  <td><select name='cyc_mode4'> <option value='galvanostatic'>Galvanostatic</option> <option value='Potentiostatic'>Potentiostatic</option> <option name='rest'>Rest</option></td> <td><input type='text' name='value' value='-2'>Either V or mA</td> <td><input type='text' name='time_cutoff4' value='10'></td> <td><input type='text' name='voltage_cutoff4' value='0'></td> <td><input type='text' name='current_cutoff4' value='0'></td>
          </tr>
        </table>
      
      <textarea id="tbTableValuesArray" name="tblValuesArray" rows="10" class='textarea'></textarea></div>
      <p id="cyc_confirm"> Waiting for Properties to be Confirmed
      
      <button onclick="convertArrayToJSON()" >Start The Experiment</button>
      
      
      
      <div id="goPlotting_button" style="visibility:hidden">
        <button type = "button" onclick="goPlotting()" style="background-color:lightgreen">View Live Plot</button></td></tr>
      </div>
    
      
    </div>
  </div>
  </section>
  
  <section id="tabs-2" class="hide">
      
    <div class="row marketing">
      <h1>Live Plotting</h1>
      <p>Click links to display different live plots</p>
    </div>

    <img id="fooplotter" src="http://coolstuffiknow.files.wordpress.com/2012/04/cool_003.jpg" width and height stuff">
    
    <p><tt id="results"></tt></p>

  </section>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" ></script>
	<script src="/javascripts/flot/jquery.flot.js"></script>
	<script src="/javascripts/flot/jquery.flot.time.js"></script>
	<script src="/javascripts/jquery-json/src/jquery.json.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
  <script>
  
  var TableData;
  
    //this is called to send cycle info
    //these variables need to be made global?? or at least accessible by thing to call plotter. can maybe get it from TableData
    function storeTblValues()
    {
       TableData = new Array();

        $('#cycler_table tr').each(function(row, tr){
            TableData[row]={
                "cyc_mode" : $(tr).find('td').eq(1).find('select').val()
                , "cyc_value": $(tr).find('td').eq(2).find('input').val()
                , "time_cutoff" :$(tr).find('td:eq(3)').find('input').val()
                , "voltage_cutoff" : $(tr).find('td:eq(4)').find('input').val()
                , "current_cutoff" : $(tr).find('td:eq(5)').find('input').val()
            }
        });
        TableData.shift();  // first row will be empty - so remove
        //TableData.push({'electro_function' = 'cycle'})
        //ugly hack to get the elements of the basic setup by their ids: could probably do this a fancier way but would spend so long trying probably not worth it
        var cyc_folder = document.getElementById("folder_name").value;
        var cyc_file = document.getElementById("file_name").value;
        var cyc_ardustat_id = document.getElementById("ardustat_id").value;
        var cyc_cycles = document.getElementById("number_of_cycles").value;
        var cyc_http_port = document.getElementById("http_port").value;
        var cyc_serial_port = document.getElementById("serial_port").value;
        TableData.unshift({'cyc_folder':cyc_folder, 'cyc_file_name':cyc_file, 'cyc_ardustat_id':cyc_ardustat_id, 'cyc_cycles':cyc_cycles, 'cyc_http_port':cyc_http_port, 'cyc_serial_port':cyc_serial_port})
        console.log(TableData);
        TableData.unshift({'electro_function':'cycle'});
        return TableData;
    }
    
    //call this to send cycle info.
    //when this is called - start a chain of call backs.
    
    function convertArrayToJSON(TableData)
    {
        //make the next button available TODO: make this a callback - look for errors etc. then call it back
        document.getElementById("goPlotting_button").style.visibility="visible";
        
        console.log('convertArraytoJSON got called');
        called()
        //goPlotting();
        //TableData = $.toJSON(storeTblValues());
        TableData = storeTblValues();
        datatosend = JSON.stringify(storeTblValues());
        //datatosend = TableData;
        $('#tbTableValuesArray').val('TableData = \n' + print_r(TableData));
        console.log(datatosend);
        //console.log(JSON.stringify(TableData[1]["cyc_file_name"]));
        $.ajax({
          type:'POST',
          url:'/senddata',
          async: true,
          data: {cycle_array: datatosend},
          success: function(){
          console.log('successful sending of things :)');
          }
        });
        
    }
    
    //debugging thing to make sure cycle data goes through correctly
    function print_r(arr,level) {
    var dumped_text = "";
    if(!level) level = 0;

    //The padding given at the beginning of the line.
    var level_padding = "";
    for(var j=0;j<level+1;j++) level_padding += "    ";

    if(typeof(arr) == 'object') { //Array/Hashes/Objects 
        for(var item in arr) {
            var value = arr[item];

            if(typeof(value) == 'object') { //If it is an array,
                dumped_text += level_padding + "'" + item + "' \n";
                dumped_text += print_r(value,level+1);
            } else {
                dumped_text += level_padding + "'" + item + "' => \"" + value + "\"\n";
            }
        }
    } else { //Stings/Chars/Numbers etc.
        dumped_text = "===>"+arr+"<===("+typeof(arr)+")";
    }
    return dumped_text;
}

  
  //TODO:should probably put this in a seperate script but lets get it working then go from there.
  //pretty much working - just not switching in the url - thats not the biggest deal though.
  //see if we can get a plot up next
  //everything working but the navtab click thing


  </script>
  <script>
  //test thing
  function called(){
    console.log("called");
    }
  
  //call the live plotter
  function goPlotting(){
    event.preventDefault();
    console.log("goPlotting got called");
    
    var active_tab_selector = $('.nav-tabs > li.active > a').attr('href');
    
    var actived_nav = $('.nav-tabs > li.active');
    actived_nav.removeClass('active');
    
    //manually switch to plotting tab
    //addClass('active');
    $("a[href$='tabs-2']").parents('li').addClass('active');
    
    //hide current tab
    $(active_tab_selector).removeClass('active');
    $(active_tab_selector).addClass('hide');
    console.log("active_tab");
    console.log($(active_tab_selector));
    
    //display plotting tab
    var target_tab_selector = $('#tabs-2');
    console.log("target tab selector");
    console.log($(target_tab_selector));
    $(target_tab_selector).removeClass('hide');
    $(target_tab_selector).addClass('active');
    
    
  ploop();
  setInterval(function() {
    console.log('ploop was called again');
    ploop();
    }, 5000);
  }
  
  //live plotting stuff
  //called by goPlotting()
  function ploop()
  {
      //TODO: add in a cycmin and cycmax thing
      //document.write("ploop was called");
      //var mintemp = document.getElementById("cycmin").value;
      //var maxtemp = document.getElementById("cycmax").value;
      var mintemp = 0;
      var maxtemp = -1;
      var ardu_folder = JSON.stringify(TableData[1]["cyc_folder"]).slice(1,-1);
      var ardu_file = JSON.stringify(TableData[1]["cyc_file_name"]).slice(1,-1);
      if(mintemp != "") { cycle_min = mintemp; }
      else { cycle_min = 0 }
      if(maxtemp != "") { cycle_max = maxtemp; }
      else { cycle_max = -1 }
      //add functionality so that can look at different plots
      var foo = "test";
      $.ajax({
      url: "http://localhost:4004/filetest_showme/" //TODO: make this more general, or in readme make sure that user sets pithy on 4001, 4003, 4004 
      + ardu_folder+"/"
      + ardu_file+"/"
      + cycle_min+"/"
      + cycle_max+"/"
      + "t"+"/"
      + "v"+"/",
      success: function(result){
          image = result
          //debug
          console.log('result from ploop');
          console.log(result);
          imageUrl = "http://localhost:4001/"+image
          //document.write(imageUrl);
          changeImage("fooplotter",imageUrl)
      },
      async:   false,
      })
  }
  
  function changeImage(id,source)
  {
  document.getElementById(id).src=source;
  }
  
  console.log("this is the navtab");
  console.log("this is working now");


  //tab stuff
  $(document).ready(function() {
      $('.nav-tabs > li > a').click(function(event){
      event.preventDefault();//stop browser to take action for clicked anchor'
      console.log("you got clicked");

      //get displaying tab content jQuery selector
      var active_tab_selector = $('.nav-tabs > li.active > a').attr('href');					

      //find actived navigation and remove 'active' css
      var actived_nav = $('.nav-tabs > li.active');
      actived_nav.removeClass('active');

      //add 'active' css into clicked navigation
      $(this).parents('li').addClass('active');
      console.log("parents");
      console.log($(this).parents('li'));

      //hide displaying tab content
      $(active_tab_selector).removeClass('active');
      $(active_tab_selector).addClass('hide');
      //console.log("active tab selector");
      //console.log($(active_tab_selector));

      //show target tab content
      var target_tab_selector = $(this).attr('href');
      //var target_tab_selector = $('.nav-tabs > #tabs-2').attr('href');
      //console.log("target tab selector");
      //console.log($(target_tab_selector));
      $(target_tab_selector).removeClass('hide');
      $(target_tab_selector).addClass('active');
       });
  });
  </script>
  <script>
/*
$.fn.serializeObject = function()
{
    var o = {};
    var a = this.serializeArray();
    $.each(a, function() {
        if (o[this.name] !== undefined) {
            if (!o[this.name].push) {
                o[this.name] = [o[this.name]];
            }
            o[this.name].push(this.value || '');
        } else {
            o[this.name] = this.value || '';
        }
    });
    o['type_of_experiment'] = 'cyclic voltammetry';
    return o;
};

function sendValues() {

  var form = $('#cycler_setup_input');
  datatosend = form.serializeObject();
  console.log(datatosend);
  $.ajax({
    type:'POST',
    url:'/senddata',
    dataType: 'json',
    async: true,
    data: datatosend,
    success: function(){
      console.log('successful sending of things :)');
    }
  });
    
  
}
  
    

		$("#cycler_submit_button").click(function(){
		  console.log('something got clicked');
		  var jim = document.forms['cv_setup_input'].elements
		  var array = document.forms['cv_setup_input'].elements.value
		  console.log(array);
					
		});  
        
        
     */
    /*
    // do on click thing - then loop through to find each element - then post it.
    
        
        $.ajax({
          type: 'POST',
        	dataType: "json",
        	async: true,
        	url: '/senddata',
        	data: {cv_setup:$("#cv_setup_input").val()},
        	success: function("here is the stuff "+stuff){
            console.log(stuff);
          }
      });
    });
    */
  </script>
</body>
